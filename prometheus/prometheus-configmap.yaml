apiVersion: v1
data:
  alerts: |
    {}
  prometheus.rules: |
    groups:
    - name: example-rules
      interval: 30s # defaults to global interval
      rules:
      - alert: "Node Down"
        expr: up{job="kubernetes-nodes"} == 0
        annotations:
          miqTarget: "ContainerNode"
          severity: "ERROR"
          url: "https://www.example.com/node_down_fixing_instructions"
          message: "Node {{$labels.instance}} is down"
      - alert: "Too Many Pods"
        expr: sum(kubelet_running_pod_count) > 15
        annotations:
          miqTarget: "ExtManagementSystem"  
          severity: "ERROR"
          url: "https://www.example.com/too_many_pods_fixing_instructions"
          message: "Too many running pods"
      - alert: "Node CPU Usage"
        expr: (100 - (avg by (instance) (irate(node_cpu{app="prometheus-node-exporter",mode="idle"}[5m])) * 100)) > 3
        for: 30s
        labels:
          severity: "ERROR"
        annotations:
          miqTarget: "ExtManagementSystem"
          severity: "ERROR"
          url: "https://www.example.com/too_many_pods_fixing_instructions"
          message: "{{$labels.instance}}: CPU usage is above 4% (current value is: {{ $value }})"
  prometheus.yml: |
    global:
      evaluation_interval: 1m
      scrape_interval: 1m
      scrape_timeout: 10s
    rule_files:
    - /etc/config/rules
    - /etc/config/alerts
    scrape_configs:
    - job_name: blackbox
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
        - targets:
          - https://digitalid-api-<namespace>-dev.pathfinder.gov.bc.ca/health
          - http://grafana-<namespace>-dev.pathfinder.gov.bc.ca
          - https://pen-demographics-api-<namespace>-dev.pathfinder.gov.bc.ca/health
          - https://pen-request-api-<namespace>-dev.pathfinder.gov.bc.ca/health
          - https://pen-request-email-api-<namespace>-dev.pathfinder.gov.bc.ca/health
          - https://pen-request-<namespace>-dev.pathfinder.gov.bc.ca/api
          - https://pen-request-<namespace>-dev.pathfinder.gov.bc.ca
          - https://services-card-api-<namespace>-dev.pathfinder.gov.bc.ca/health
          - https://soam-api-<namespace>-dev.pathfinder.gov.bc.ca/health
          - https://<namespace>-dev.pathfinder.gov.bc.ca
          - https://student-admin-<namespace>-dev.pathfinder.gov.bc.ca/api/health
          - https://student-admin-<namespace>-dev.pathfinder.gov.bc.ca
          - https://student-api-<namespace>-dev.pathfinder.gov.bc.ca/health
          - https://digitalid-api-<namespace>-test.pathfinder.gov.bc.ca/health
          - https://pen-demographics-api-<namespace>-test.pathfinder.gov.bc.ca/health
          - https://pen-request-api-<namespace>-test.pathfinder.gov.bc.ca/health
          - https://pen-request-email-api-<namespace>-test.pathfinder.gov.bc.ca/health
          - https://pen-request-<namespace>-test.pathfinder.gov.bc.ca/api
          - https://pen-request-<namespace>-test.pathfinder.gov.bc.ca
          - https://services-card-api-<namespace>-test.pathfinder.gov.bc.ca/health
          - https://soam-api-<namespace>-test.pathfinder.gov.bc.ca/health
          - https://<namespace>-test.pathfinder.gov.bc.ca
          - https://student-admin-<namespace>-test.pathfinder.gov.bc.ca/api/health
          - https://student-admin-<namespace>-test.pathfinder.gov.bc.ca
          - https://student-api-<namespace>-test.pathfinder.gov.bc.ca/health
          - https://sonarqube-<namespace>-tools.pathfinder.gov.bc.ca
          - https://jenkins-<namespace>-tools.pathfinder.gov.bc.ca/login
      relabel_configs:
        - source_labels: [__address__]
          target_label: __param_target
        - source_labels: [__param_target]
          target_label: instance
        - target_label: __address__
          replacement: test-blackbox-exporter-<namespace>-dev.pathfinder.gov.bc.ca # Blackbox exporter.
    - job_name: prometheus
      static_configs:
      - targets:
        - localhost:9090
    - job_name: kubernetes-pods
      metrics_path: /actuator/prometheus
      kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
            - <namespace>-dev
      relabel_configs:
      - action: keep
        regex: true
        source_labels:
        - __meta_kubernetes_pod_annotation_prometheus_io_scrape
      - action: replace
        regex: (.+)
        source_labels:
        - __meta_kubernetes_pod_annotation_prometheus_io_path
        target_label: __metrics_path__
      - action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        source_labels:
        - __address__
        - __meta_kubernetes_pod_annotation_prometheus_io_port
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - action: replace
        source_labels:
        - __meta_kubernetes_namespace
        target_label: kubernetes_namespace
      - action: replace
        source_labels:
        - __meta_kubernetes_pod_name
        target_label: kubernetes_pod_name
  rules: |
    {}
kind: ConfigMap
metadata:
  creationTimestamp: '2020-01-31T02:09:29Z'
  labels:
    app: prometheus-service
    chart: prometheus-8.11.4
    component: prometheus-service
    heritage: Tiller
    release: prometheus-service
    template: prometheus-template
  name: prometheus-service
  namespace: <namespace>-dev
  resourceVersion: '1640255314'
  selfLink: /api/v1/namespaces/<namespace>-dev/configmaps/prometheus-service
  uid: b6926f71-43ce-11ea-8a92-0050568379a2
